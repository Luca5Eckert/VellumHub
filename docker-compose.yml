version: '3.8'

name: media-recommendation-system

networks:
  mrs-network:
    driver: bridge

services:
  # ==========================================
  # DATABASES LAYER
  # ==========================================
  postgres-catalog:
    image: postgres:15-alpine
    container_name: postgres-catalog
    restart: unless-stopped
    shm_size: 256mb
    command: postgres -c shared_buffers=256MB -c max_connections=200 -c work_mem=16MB
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: catalog_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_catalog_data:/var/lib/postgresql/data
    networks:
      - mrs-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d catalog_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  postgres-engagement:
    image: postgres:15-alpine
    container_name: postgres-engagement
    restart: unless-stopped
    shm_size: 256mb
    command: postgres -c shared_buffers=256MB -c max_connections=200 -c work_mem=16MB
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: engagement_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_engagement_data:/var/lib/postgresql/data
    networks:
      - mrs-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d engagement_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  postgres-user:
    image: postgres:15-alpine
    container_name: postgres-user
    restart: unless-stopped
    shm_size: 256mb
    command: postgres -c shared_buffers=256MB -c max_connections=200 -c work_mem=16MB
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: user_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_user_data:/var/lib/postgresql/data
      - ./scripts/create-admin-user.sql:/docker-entrypoint-initdb.d/init-admin.sql
    networks:
      - mrs-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d user_db" ]
      interval: 5s
      timeout: 5s
      retries: 10

  postgres-recommendation:
    image: pgvector/pgvector:pg15
    container_name: postgres-recommendation
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: recommendation_db
    ports:
      - "5435:5432"
    volumes:
      - postgres_recommendation_data:/var/lib/postgresql/data
      - ./scripts/create-vector-in-recommendation-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mrs-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d recommendation_db" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================
  # MESSAGING LAYER
  # ==========================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_log:/var/lib/zookeeper/log
    networks:
      - mrs-network
    healthcheck:
      test: echo srvr | nc localhost 2181 || exit 1
      interval: 10s
      retries: 10

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "9101:9101"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - mrs-network
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_ZOOKEEPER_CONNECT_TIMEOUT_MS: 60000
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_HEAP_OPTS: "-Xmx512M -Xms512M"
      KAFKA_JMX_PORT: 9101
      KAFKA_JMX_HOSTNAME: localhost
    healthcheck:
      test: nc -z localhost 9092 || exit 1
      interval: 10s
      retries: 15
      start_period: 20s

  kafka-ui:
    image: provectuslabs/kafka-ui@sha256:8f2ff02d64b0a7a2b71b6b3b3148b85f66d00ec20ad40c30bdcd415d46d31818
    container_name: kafka-ui
    restart: unless-stopped
    ports:
      - "8090:8080"
    networks:
      - mrs-network
    environment:
      KAFKA_CLUSTERS_0_NAME: vellumhub-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTERS_0_JMXPORT: 9101
      DYNAMIC_CONFIG_ENABLED: 'true'
    depends_on:
      kafka:
        condition: service_healthy

  # ==========================================
  # MICROSERVICES LAYER
  # ==========================================
  catalog-service:
    build: ./catalog-service
    container_name: catalog-service
    restart: on-failure
    ports:
      - "8081:8080"
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: 8080
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx512m"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-catalog:5432/catalog_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      JWT_KEY: ${JWT_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    networks:
      - mrs-network
    depends_on:
      postgres-catalog:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 45s

  engagement-service:
    build: ./engagement-service
    container_name: engagement-service
    restart: on-failure
    ports:
      - "8083:8080"
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: 8080
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx512m"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-engagement:5432/engagement_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      JWT_KEY: ${JWT_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    networks:
      - mrs-network
    depends_on:
      postgres-engagement:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 45s

  user-service:
    build: ./user-service
    container_name: user-service
    restart: on-failure
    ports:
      - "8084:8080"
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: 8080
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx512m"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-user:5432/user_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      JWT_KEY: ${JWT_KEY}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    networks:
      - mrs-network
    depends_on:
      postgres-user:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 45s

  recommendation-service:
    build: ./recommendation-service
    container_name: recommendation-service
    restart: on-failure
    ports:
      - "8085:8080"
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: 8080
      SPRING_MAIN_ALLOW_BEAN_DEFINITION_OVERRIDING: "true"
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx512m"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-recommendation:5432/recommendation_db
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      JWT_KEY: ${JWT_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    networks:
      - mrs-network
    depends_on:
      postgres-recommendation:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 45s

volumes:
  postgres_catalog_data:
  postgres_engagement_data:
  postgres_user_data:
  postgres_recommendation_data:
  kafka_data:
  zookeeper_data:
  zookeeper_log: